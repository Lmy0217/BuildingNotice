<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
		<meta name="misapplication-tap-highlight" content="no" />
		<meta name="HandheldFriendly" content="true" />
		<meta name="MobileOptimized" content="320" />
		<title>采集信息浏览</title>
		<link rel="stylesheet" href="../css/mui.min.css" type="text/css" />
		<link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8" />
		<style type="text/css">
			li {
				padding: 0.3em;
				border-bottom: 1px solid #eaeaea;
				text-align: left;
			}

			li:active {
				background: #f4f4f4;
			}
		</style>
		<script type="text/javascript" src="../js/jquery.min.js"></script>
		<script type="text/javascript" src="../js/jquery.serializejson.min.js"></script>
		<script type="text/javascript" src="../js/mui.min.js"></script>
		<script type="text/javascript" src="../js/util.js"></script>
		<script type="text/javascript" src="../js/form.js"></script>
		<script type="text/javascript" src="../js/common.js"></script>
		<script type="text/javascript" src="../js/loading.js"></script>
		<script type="text/javascript">
			//取消浏览器的所有事件，使得active的样式在手机上正常生效
			document.addEventListener('touchstart', function() {
				return false;
			}, true);
			var website = 'http://111.73.197.144:8080/buildingnotice';
			mui.init({
				/* 在页面的指定位置，加载子页面，实现卡头卡尾的效果 */
				// subpages: [{
				// 	url: "listInfo.html", //子页面HTML地址，支持本地地址和网络地址
				// 	id: "listInfo.html", //子页面标志
				// 	styles: {
				// 		top: "45px", //子页面顶部位置(顶部选项卡默认高度45px)
				// 		bottom: "51px", //子页面底部位置(顶部导航栏默认高度51px)
				// 		//width:100%,//子页面宽度，默认为100%
				// 		//height:100%,//子页面高度，默认为100%
				// 	},
				// 	//			      extras:{}//额外扩展参数,页面传值时使用
				// }],
			});
			mui.plusReady(function() {
				$('#scroll').scroll({
					indicators: true //是否显示滚动条
				});
				mui('.mui-scroll-wrapper').scroll({
					deceleration: 0.0005
				}); //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
				w_showInfo();
				var backa = document.getElementById('goHome');
				backa.addEventListener("tap", function() {
					mui.back();
					goHome();
				})

				document.getElementById('submit').addEventListener("tap", function() {
					info = getForm('#' + 'infoForm');
					var perChk = info.perChk;
					openDB();
					for (i = 0; i < perChk.length; i++) {
						// console.log(perChk[i]);
						plus.sqlite.selectSql({
							name: 'info',
							sql: 'select rowid, * from infoDB where rowid==' + perChk[i],
							success: function(e) {
								console.log('selectSql success: ' + JSON.stringify(e));
								// console.log(JSON.stringify(e));
								photoId = upPhoto(e[0]);
								console.log(photoId);
								data = zhenliJson(e, photoId);
								upData(e);
							},
							fail: function(e) {
								console.log('selectSql fail: ' + JSON.stringify(e));
							}
						});
					}
					closeDB();

				})

				// 扩展API加载完毕后调用onPlusReady回调函数 

			});

			function upData(data) {
				var upUrl = website + '/archive/create';
				var sendData = data;
				console.log(data)
				// {
				// 	'data': data,
				// }
				// var AUTH_TOKEN = myStorage.getItem('AUTH_TOKEN');
				// var USER_KEY = myStorage.getItem('USER_KEY');
				mui.ajax(upUrl, {
					type: 'POST',
					dataType: 'json',
					data: sendData[0],
					contentType: "application/json; charset=UTF-8",
					async: true,
					timeout: 100000, //超时时间设置为10秒；
					success: function(res) {
						if (typeof res == 'string') {
							var res = JSON.parse(res);
						}
						//如果登陆失效
						if (res.status == '401') {
							mui.toast(res.msg);
							clearUserInfoCache(myStorage)
							mui.openWindow({
								url: 'login.html'
							})
						} else if (res.code == '403') {
							mui.toast(res.msg);
							hideLoading();
							return false;
						}
						if (res.code != '200') {
							mui.toast(res.msg);
						}
						hideLoading();
						plus.sqlite.selectSql({
							name: 'info',
							sql: 'updata infoDB set isUp = 1 where rowid = ' + data.rowid,
							success: function(e) {
								console.log('selectSql success: ' + JSON.stringify(e));
								return true;
							},
							fail: function(e) {
								console.log('selectSql fail: ' + JSON.stringify(e));
							}
						});
					},
					error: function(xhr, type, errorThrown) {
						console.log(JSON.stringify(xhr));
						// vm.uploadImgArr[k].status = -1;
						// hideLoading();
					},
					headers: {
						// 'access_token': AUTH_TOKEN,
						// 'user_key': USER_KEY,
					}
				});
			}

			function zhenliJson(res, photoId) {
				res['imags'] = photoId;
				return res;
			}

			function upPhoto(result) {
				var imgUrl = website + '/image/upload';
				var photoId = new Array();
				watchJSON(result);
				for (i = 1; i <= 4; i++) {
					var photoSrc = 'photoSrc' + i;
					var photoDes = 'photoDes' + i;
					
					if (!result[photoSrc] == '') {
						console.log(typeof(result[photoSrc])+'_'+photoSrc)
						var image = new Image();
						image.style.width = "60px";
						image.style.height = "60px";
						image.src = result[photoSrc];
						// var files = document.getElementById('image');
						// 上传文件
						// --------------
						console.log(image);
						// uploadPictuer(image,imgUrl);
						// --------------
						// console.log(image);
						console.log(image.src);
						// var AUTH_TOKEN = myStorage.getItem('AUTH_TOKEN');
						var token = localStorage.getItem('TOKEN_TOKEN');
						
						 // image.onload = function() {
							var imgData = getBase64Image(image);
							// 
							var imgBlob = dataURLtoBlob(imgData);
							console.log(imgBlob);
						 // }
						
						// console.log(JSON.stringify(data));
						var wd = plus.nativeUI.showWaiting();

						// 调用ajax  
						var data = {
							'token': token,
							'file': imgBlob,
							'depict': result[photoDes],
						}
						console.log(imgUrl);
						postData(imgUrl, //服务端的URL  
							data, // json 数据  
							function(data) {
								wd.close(); // 调用成功，先关闭等待的对话框  
								if (data.status == "401") {
									// 如果密码错误，提示一下信息  
									mui.alert(data.msg);
									clearUserInfoCache(myStorage)
									mui.openWindow({
										url: 'login.html'
									})
								} else if (data.status != "200") {
									// 如果密码错误，提示一下信息  
									mui.alert(data.msg);
									return false;
								} else {
									return data.imageid;
								}
								// // 保存token，以便于下次自动登录  
								// localStorage.setItem(TOKEN_USER, $id('account').value);
								// localStorage.setItem(TOKEN_LOGIN, data.token);
								// 清空用户名，密码  
							},
							wd //传递给postData的最后一个参数，失败的时候关闭等待对话框  
						);
					}
				}

			}

			function uploadPictuer(files, depict, server) {
				var wt = plus.nativeUI.showWaiting();
				var task = plus.uploader.createUpload(server, {
						method: "POST"
					},
					function(t, status) { //上传完成
						if (status == 200) {
							alert("上传成功：" + t.responseText);
							wt.close(); //关闭等待提示按钮
						} else {
							alert("上传失败：" + status);
							wt.close(); //关闭等待提示按钮
						}
					}
				);
				//添加其他参数
				task.addData("depict", depict);
				task.addFile(files.src, {
					key: "dddd"
				});
				task.start();
			}

			function postData(url, data, callback, waitingDialog) {
				console.log()
				console.log(data);
				console.log(url);
				// var formData = new FormData();
				var formData = new FormData();
				// formData.append("accountnum", 123456); 
				formData.append('depict', data.depict);

				formData.append('file', new File([data.file], '12345.png'));
				// formData.append('new', data.file);
				// Object.keys(data).forEach((key) => {
				//   formData.append(key, data[key]);
				// });
				console.log(formData);
				mui.ajax(url, {
					data: formData,
					// cache: false,
					processData: false,
					contentType: false,
					type: 'post',
					// contentType: "multipart/form-data",
					timeout: 50000,
					success: callback,
					error: function(xhr, type, errorThrown) {
						waitingDialog.close();
						console.log(JSON.stringify(errorThrown));
						mui.alert("<网络连接失败，请重新尝试一下>", "错误", "OK", null);

					},
					headers: {
						// 'access_token': AUTH_TOKEN,
						// 'user_key': USER_KEY,
					}
				});
			}

			function w_showInfo() {
				openDB();
				plus.sqlite.selectSql({
					name: 'info',
					sql: 'select rowid, * from infoDB where isUp==0',
					success: function(e) {
						console.log('selectSql success: ' + JSON.stringify(e));
						showInfo(e);
						closeDB();
					},
					fail: function(e) {
						console.log('selectSql fail: ' + JSON.stringify(e));
						closeDB();
					}
				});
			}

			function showInfo(result) {
				watchJSON(result);
				var mainList = document.getElementById("mainList");
				for (i = 0; i < result.length; i++) {
					var temp = "<li class='mui-table-view-cell'>" +
						"<div class='mui-input-row mui-checkbox mui-left'>" +
						"<label>" + result[i].hold + "</label>" +
						"<input name='perChk[]' value='" + result[i].rowid + "' type='checkbox' >" +
						"</div>" +
						"</li>"
					// console.log(temp);
					mainList.innerHTML += temp;
				}
			}
			//打开"采集信息"
			function allChk(iNum) {
				// var aForm = document.getElementById("mainList");
				var mychk = document.getElementsByName("perChk[]");
				for (var i = 0; i < mychk.length; i++) {
					if (iNum <= 0) {
						mychk[i].checked = !mychk[i].checked;
					} else {
						mychk[i].checked = iNum;
					}
				}

			}
			//打开"任务上传"
			function openSubmit() {
				var url = "testTakePhoto.html";
				plus.webview.create(url).show();
			}
		</script>
	</head>
	<body onselectstart="return false;">
		<!-- <div class="mui-inner-wrap" style="position: relative;"> -->

		<header class="mui-bar mui-bar-nav">
			<a id="goHome" class="mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">信息预览与上传</h1>
		</header>
		<div class="line mui-bar-nav" style="position: fixed; text-indent: 10px; height: 40px; line-height: 40px; top: 44px;padding-top: 10px;width: 100%;">
			<div class="line" style="width:20%; float: left;">选择</div>
			<div class="line" style="width:80%; float: right; font-weight: bold; text-align:center;">户主姓名</div>
		</div>
		<div class="mui-content">
			<div id="scroll1" class="mui-scroll-wrapper" style="top: 84px; bottom: 102px;">
				<!--MUI默认是position是absolute-->
				<div class="mui-scroll">
					<form id='infoForm' class="">
						<ul id="mainList" class="mui-table-view">
							<!-- <li class='mui-table-view-cell'><div class='mui-input-row mui-checkbox mui-left'><label>很少说话</label><input name='perChk' value='14' type='checkbox' ></div></li> -->
						</ul>
					</form>
				</div>
			</div>
		</div>
		<div class="line mui-row" style="position: fixed;bottom: 0px; z-index: 10px;width:100%;margin: 0px;">
			<!--需要固定在底部，所以需要用到绝对定位，另外，由于MUI本身的组件的z-index要高于我们自己的div，所以，这里需要自定义z-index，一般10就足够。-->
			<!-- <div id="btnCtrl" class="mui-btn mui-btn-primary mui-btn-block">
				应用设置
			</div> -->
			<button class="mui-btn mui-btn-primary mui-col-xs-6" onclick="allChk(1)" style="height: 40px;margin-top: 5px; ">全选</button>
			<button class="mui-btn mui-btn-primary mui-col-xs-6" onclick="allChk(0)" style="height: 40px;margin-top: 5px ;">反选</button>

			<button id="submit" class="mui-btn mui-btn-primary mui-btn-block" onclick="" style="margin: 0;margin-top: 5px;">提交</button>
		</div>
		<!-- </div> -->
	</body>
</html>
